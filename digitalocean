const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const Airtable = require('airtable');

const app = express();
const server = http.createServer(app);
const io = socketIo(server);

const PORT = process.env.PORT || 3000;

// Airtable setup
const base = new Airtable({ apiKey: 'YOUR_AIRTABLE_API_KEY' }).base('YOUR_BASE_ID');
const table = base('YOUR_TABLE_NAME');

// Serve a simple message at the root
app.get('/', (req, res) => {
    res.send('WebSocket server is running');
});

// Listen for new events in Airtable
table.select({
    // Your Airtable view or filter options
    view: 'Grid view'
}).eachPage((records, fetchNextPage) => {
    records.forEach(record => {
        // Emit event to all connected clients
        io.emit('new-event', record.fields);
    });

    fetchNextPage();
});

// WebSocket connection
io.on('connection', (socket) => {
    console.log('New client connected');
    
    socket.on('disconnect', () => {
        console.log('Client disconnected');
    });
});

server.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});
